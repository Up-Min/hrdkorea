package Controller;

import java.io.IOException;
import java.io.PrintWriter;
import java.sql.SQLException;
import java.util.Arrays;
import java.util.List;

import javax.servlet.ServletConfig;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.beanutils.BeanUtils;

import DAO.wk_DAO;
import DTO.logininfo;

/**
 * Servlet implementation class wk_Controller
 */
@WebServlet("/")
public class wk_Controller extends HttpServlet {
	private static final long serialVersionUID = 1L;
    private wk_DAO dao;
    private ServletContext ctx;
	
	
    @Override
	public void init(ServletConfig config) throws ServletException {
		super.init(config);
		dao = new wk_DAO();
		ctx = getServletContext();
	}

	public wk_Controller() {
        super();
    }

	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		request.setCharacterEncoding("UTF-8");
		doIt(request, response);
	}

	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		request.setCharacterEncoding("UTF-8");
		doIt(request, response);
	}

	protected void doIt(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String context = request.getContextPath();
		String command = request.getServletPath();
		String site = null;
		
		
		switch (command) {
		case "/index" : site = "index.jsp"; break;
		case "/signup": site = signUp(request); break;
		case "/signin": site = signIn(request, response); break;
		case "/main" : site = "main.jsp"; break;
		case "/start" : site = "wk_insert.jsp"; break;
		case "/insert" : site = insertWorkout(request); break;
		
		}
		
		if(site.startsWith("redirect:/")) { // "" 안에 시작하는 문자열을 찾아준다.
			String rview = site.substring("redirect:/".length());
			System.out.println(rview);
			response.sendRedirect(rview);
		}else{
			ctx.getRequestDispatcher("/"+site).forward(request, response);
		}
	}
	
	public String signUp(HttpServletRequest request) {
		logininfo l = new logininfo();
		try {
			BeanUtils.populate(l, request.getParameterMap());
			dao.signUp(l);
		} catch(Exception e) {
			e.printStackTrace();
		}
		System.out.println("index");
		return "redirect:/index";
	}
	
	
	public String signIn(HttpServletRequest request, HttpServletResponse response) {
		try {
			String id = request.getParameter("user_id");
			String num = request.getParameter("user_number");
			logininfo l = dao.signIn(request);
			
			if(id.equals(l.getUser_id()))  {
				request.setAttribute("id", l.getUser_id());
				request.setAttribute("num",l.getUser_number());
				return "main";
			}else {
				response.setContentType("text/html; charset=UTF-8");
				PrintWriter out = response.getWriter();
				out.print("<script>");
				out.print("alert('로그인 정보가 정확하지 않습니다.'); location.href = 'index.jsp';");
				out.print("</script>");
				out.flush();
				
			}
		} catch(Exception e) {
			e.printStackTrace();
		}
		System.out.println("con_signin");
		return "main";
	}
	
	public String insertWorkout (HttpServletRequest request) {
		try {
			String[] s_temp1 = request.getParameterValues("ex_name[]");
			String[] s_temp2 = request.getParameterValues("ex_weight");
			String[] s_temp3 = request.getParameterValues("ex_reps");
			String[] s_temp4 = request.getParameterValues("ex_sets");
			int length2 = s_temp2.length;
			int length3 = s_temp3.length;
			int length4 = s_temp4.length;
			System.out.println(Arrays.toString(s_temp1));
			System.out.println(length2);
			System.out.println(length3);
			System.out.println(length4);
			
			dao.insertWorkout(request);
			dao.getWorkoutnum(request);
			dao.insertExercise(request);
		} catch (SQLException e) {
			e.printStackTrace();
		}
		return "main";
	}
	
	
}
